<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ„ è–èª•æ¨¹è£é£¾å·¥å…·</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:#0b1d3a;
  overflow:hidden;
  font-family:system-ui,-apple-system,sans-serif;
  color:white;
}
canvas{display:block}

/* å·¦å´é¢æ¿ */
.controls{
  position:fixed;
  left:16px;
  top:16px;
  background:rgba(20,30,50,.85);
  padding:14px;
  border-radius:14px;
  z-index:10;
  font-size:13px;
  box-shadow:0 8px 20px rgba(0,0,0,.4);
  width:170px;
}
.controls label{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:6px;
}
.controls input{margin-left:6px}
.controls button,select{
  margin-top:6px;
  width:100%;
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
button{background:#ffd86b}

/* å¾©åŸå·¥å…·åˆ— */
.undoBar{
  display:flex;
  gap:6px;
}
.undoBtn{
  flex:1;
  font-size:18px;
  font-weight:bold;
}

/* ä½¿ç”¨èªªæ˜ */
.helpBtn{
  position:fixed;
  right:16px;
  top:16px;
  z-index:10;
  background:#fff2a8;
  color:#333;
  border:none;
  padding:8px 12px;
  border-radius:20px;
  cursor:pointer;
  font-weight:bold;
}
.helpOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}
.helpBox{
  background:#1b2a4a;
  max-width:420px;
  padding:20px;
  border-radius:16px;
  line-height:1.6;
}
.helpBox h2{margin-top:0}
</style>
</head>

<body>

<div class="controls">
  <div class="undoBar">
    <button class="undoBtn" onclick="undo()">â†¶</button>
    <button class="undoBtn" onclick="redo()">â†·</button>
  </div>

  <strong>ğŸ¨ é¡è‰²</strong>
  <label>ğŸŒ² <input type="color" id="leaf" value="#1f6b45"></label>
  <label>ğŸ€ <input type="color" id="ribbon" value="#d4af37"></label>
  <label>ğŸ€ğŸ <input type="color" id="bow" value="#ffd86b"></label>
  <label>ğŸ”´ <input type="color" id="ball" value="#c0392b"></label>
  <label>ğŸ <input type="color" id="gift" value="#ff6fae"></label>
  <label>â­ <input type="color" id="star" value="#fff2a8"></label>

  <button onclick="addGift()">â• æ–°å¢ç¦®ç‰©</button>

  <select id="saveList"></select>
  <button onclick="saveDesign()">ğŸ’¾ å„²å­˜</button>
  <button onclick="loadDesign()">ğŸ“‚ è¼‰å…¥</button>
  <button onclick="exportPNG()">ğŸ“¸ åŒ¯å‡º PNG</button>
</div>

<button class="helpBtn" onclick="toggleHelp()">â“ ä½¿ç”¨èªªæ˜</button>

<div class="helpOverlay" id="help">
  <div class="helpBox">
    <h2>ä½¿ç”¨èªªæ˜</h2>
    <p>
      é»é¸ç‰©ä»¶æœƒé¡¯ç¤ºé¸å–æ¡†<br>
      æ‹–æ›³å¯ç§»å‹•å°çƒã€å½©å¸¶ã€ç¦®ç‰©<br>
      é»ç©ºç™½è™•æ–°å¢å°çƒ<br>
      Delete / Backspace åˆªé™¤é¸å–ç‰©ä»¶<br>
      â†¶ å¾©åŸ / â†· é‡åšï¼ˆCtrl+Z / Ctrl+Yï¼‰<br>
      å½©å¸¶æ¥è¿‘æ­£ç¢ºä½ç½®æœƒè‡ªå‹•å¸é™„<br>
      å¯å„²å­˜å¤šå€‹è¨­è¨ˆä¸¦è¼‰å…¥<br>
      åŒ¯å‡º PNG å¯å­˜åœ–ç‰‡
    </p>
    <button onclick="toggleHelp()">é—œé–‰</button>
  </div>
</div>

<canvas id="c"></canvas>

<script>
/* ===== åŸºæœ¬ ===== */
const c=document.getElementById("c");
const ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
resize();addEventListener("resize",resize);
const CX=()=>c.width/2;

/* ===== é¡è‰² ===== */
const colors={};
["leaf","ribbon","bow","ball","gift","star"].forEach(id=>{
  const el=document.getElementById(id);
  colors[id]=el.value;
  el.oninput=e=>colors[id]=e.target.value;
});

/* ===== ç‹€æ…‹ ===== */
let balls=[];
let ribbons=[{y:250},{y:290},{y:330},{y:370}];
let gifts=[];
let selected=null;
let undoStack=[],redoStack=[];

/* ===== æ­·å² ===== */
function snapshot(){
  undoStack.push(JSON.stringify({balls,ribbons,gifts,colors}));
  if(undoStack.length>40)undoStack.shift();
  redoStack.length=0;
}
function undo(){
  if(!undoStack.length)return;
  redoStack.push(JSON.stringify({balls,ribbons,gifts,colors}));
  const s=JSON.parse(undoStack.pop());
  balls=s.balls;ribbons=s.ribbons;gifts=s.gifts;
  Object.assign(colors,s.colors);
}
function redo(){
  if(!redoStack.length)return;
  undoStack.push(JSON.stringify({balls,ribbons,gifts,colors}));
  const s=JSON.parse(redoStack.pop());
  balls=s.balls;ribbons=s.ribbons;gifts=s.gifts;
  Object.assign(colors,s.colors);
}
document.addEventListener("keydown",e=>{
  if(e.ctrlKey&&e.key==="z"){e.preventDefault();undo()}
  if((e.ctrlKey&&e.key==="y")||(e.ctrlKey&&e.shiftKey&&e.key==="Z")){
    e.preventDefault();redo()
  }
  if(e.key==="Backspace"&&selected){
    snapshot();
    balls=balls.filter(o=>o!==selected);
    ribbons=ribbons.filter(o=>o!==selected);
    gifts=gifts.filter(o=>o!==selected);
    selected=null;
  }
});

/* ===== æ“ä½œ ===== */
let dragging=false;
function down(x,y){
  selected=null;
  balls.forEach(b=>{
    if(Math.hypot(x-(CX()+b.x),y-b.y)<10)selected=b;
  });
  ribbons.forEach(r=>{
    if(Math.abs(y-r.y)<10)selected=r;
  });
  gifts.forEach(g=>{
    if(x> CX()+g.x-20 && x< CX()+g.x+20 && y>g.y && y<g.y+30)selected=g;
  });
  if(!selected){
    snapshot();
    balls.push({x:x-CX(),y});
    selected=balls.at(-1);
  }
  dragging=true;
}
function move(x,y){
  if(!dragging||!selected)return;
  if(selected.x!=null)selected.x=x-CX();
  selected.y=y;
}
function up(){dragging=false}

c.onmousedown=e=>down(e.offsetX,e.offsetY);
c.onmousemove=e=>move(e.offsetX,e.offsetY);
c.onmouseup=up;
c.ontouchstart=e=>{
  const t=e.touches[0];down(t.clientX,t.clientY)
};
c.ontouchmove=e=>{
  const t=e.touches[0];move(t.clientX,t.clientY)
};
c.ontouchend=up;

/* ===== ç¦®ç‰© ===== */
function addGift(){
  snapshot();
  gifts.push({x:0,y:450});
}

/* ===== ç¹ªè£½ ===== */
function draw(){
  ctx.clearRect(0,0,c.width,c.height);

  // æ˜Ÿæ˜Ÿ
  ctx.save();
  ctx.translate(CX(),130);
  ctx.fillStyle=colors.star;
  ctx.beginPath();
  for(let i=0;i<5;i++){
    ctx.lineTo(Math.cos((18+i*72)*Math.PI/180)*14,
               -Math.sin((18+i*72)*Math.PI/180)*14);
    ctx.lineTo(Math.cos((54+i*72)*Math.PI/180)*6,
               -Math.sin((54+i*72)*Math.PI/180)*6);
  }
  ctx.fill();ctx.restore();

  // æ¨¹è‘‰
  function leaf(y,w,h){
    ctx.fillStyle=colors.leaf;
    ctx.beginPath();
    ctx.moveTo(CX()-w/2,y);
    ctx.quadraticCurveTo(CX(),y-h,CX()+w/2,y);
    ctx.quadraticCurveTo(CX(),y+h*0.7,CX()-w/2,y);
    ctx.fill();
  }
  leaf(200,180,60);
  leaf(245,240,70);
  leaf(290,320,80);

  // å½©å¸¶
  ctx.strokeStyle=colors.ribbon;
  ctx.lineWidth=4;
  ribbons.forEach(r=>{
    ctx.beginPath();
    ctx.moveTo(CX()-160,r.y);
    ctx.quadraticCurveTo(CX(),r.y-20,CX()+160,r.y);
    ctx.stroke();
    if(selected===r){
      ctx.setLineDash([5,5]);
      ctx.strokeRect(CX()-170,r.y-10,340,20);
      ctx.setLineDash([]);
    }
  });

  // å°çƒ
  balls.forEach(b=>{
    ctx.fillStyle=colors.ball;
    ctx.beginPath();
    ctx.arc(CX()+b.x,b.y,8,0,Math.PI*2);
    ctx.fill();
    if(selected===b){
      ctx.setLineDash([4,4]);
      ctx.strokeStyle="white";
      ctx.beginPath();
      ctx.arc(CX()+b.x,b.y,12,0,Math.PI*2);
      ctx.stroke();
      ctx.setLineDash([]);
    }
  });

  // æ¨¹å¹¹
  ctx.fillStyle="#8b5a2b";
  ctx.fillRect(CX()-18,310,36,140);

  // ç¦®ç‰©
  gifts.forEach(g=>{
    ctx.fillStyle=colors.gift;
    ctx.fillRect(CX()+g.x-20,g.y,40,30);
    ctx.fillStyle=colors.bow;
    ctx.beginPath();
    ctx.arc(CX()+g.x,g.y-4,4,0,Math.PI*2);
    ctx.fill();
  });

  requestAnimationFrame(draw);
}
draw();

/* ===== å­˜æª” ===== */
function saveDesign(){
  const name=prompt("å­˜æª”åç¨±?");
  if(!name)return;
  localStorage.setItem("tree-"+name,JSON.stringify({balls,ribbons,gifts,colors}));
  refreshList();
}
function loadDesign(){
  const k=saveList.value;
  if(!k)return;
  const d=JSON.parse(localStorage.getItem(k));
  balls=d.balls;ribbons=d.ribbons;gifts=d.gifts;
  Object.assign(colors,d.colors);
}
function refreshList(){
  saveList.innerHTML="";
  Object.keys(localStorage).filter(k=>k.startsWith("tree-")).forEach(k=>{
    const o=document.createElement("option");
    o.value=k;o.textContent=k.replace("tree-","");
    saveList.appendChild(o);
  });
}
refreshList();

function exportPNG(){
  const a=document.createElement("a");
  a.download="christmas-tree.png";
  a.href=c.toDataURL();
  a.click();
}
function toggleHelp(){
  help.style.display=help.style.display==="flex"?"none":"flex";
}
</script>
</body>
</html>
