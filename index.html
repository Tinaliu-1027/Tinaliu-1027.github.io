<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ„ è–èª•æ¨¹è£é£¾</title>
<style>
html,body{margin:0;height:100%;background:#081b3a;font-family:sans-serif}
canvas{display:block}
#panel{
  position:fixed;left:12px;top:12px;
  background:#0f223f;color:#fff;
  padding:12px;border-radius:12px;
  width:210px;font-size:14px
}
#panel h3{margin:0 0 6px}
#panel label{display:flex;align-items:center;margin:4px 0}
#panel span{flex:1}
#panel input[type=color]{width:48px;height:28px;border:none}
button,select{
  width:100%;margin-top:6px;
  padding:6px;border-radius:6px;border:none;
  cursor:pointer
}
#topbar{
  position:fixed;right:12px;top:12px;display:flex;gap:6px
}
#topbar button{padding:6px 10px;border-radius:8px}
#help{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  display:none;align-items:center;justify-content:center
}
#helpBox{
  background:#fff;color:#000;
  padding:20px;border-radius:12px;
  width:420px;max-width:90%
}
</style>
</head>
<body>

<canvas id="c"></canvas>

<div id="panel">
  <h3>ğŸ¨ é¡è‰²è¨­å®š</h3>
  <label><span>ğŸŒ² æ¨¹è‘‰</span><input type="color" id="cTree" value="#1f6b3a"></label>
  <label><span>ğŸ€ å½©å¸¶</span><input type="color" id="cRibbon" value="#e1b63b"></label>
  <label><span>ğŸ”´ å°çƒ</span><input type="color" id="cBall" value="#c93b2b"></label>
  <label><span>ğŸ ç¦®ç‰©</span><input type="color" id="cGift" value="#ff77aa"></label>
  <label><span>â­ æ˜Ÿæ˜Ÿ</span><input type="color" id="cStar" value="#ffeaa0"></label>

  <button id="addGift">â• æ–°å¢ç¦®ç‰©</button>

  <select id="slot"></select>
  <button id="save">ğŸ’¾ å„²å­˜</button>
  <button id="load">ğŸ“‚ è¼‰å…¥</button>
  <button id="export">ğŸ“¸ åŒ¯å‡º PNG</button>
</div>

<div id="topbar">
  <button id="undo">â†¶</button>
  <button id="redo">â†·</button>
  <button id="helpBtn">â“ ä½¿ç”¨èªªæ˜</button>
</div>

<div id="help">
  <div id="helpBox">
    <h2>ğŸ“– ä½¿ç”¨èªªæ˜</h2>
    <ul>
      <li>é»ç•«é¢ï¼šæ–°å¢å°çƒ</li>
      <li>æ‹–æ›³å½©å¸¶ï¼šå¯ä¸Šä¸‹ç§»å‹•ï¼ˆæœ‰å¸é™„ç·šï¼‰</li>
      <li>é»é¸ç‰©ä»¶ + Backspaceï¼šåˆªé™¤</li>
      <li>Ctrl+Z / Ctrl+Yï¼šå¾©åŸ / é‡åš</li>
      <li>å„²å­˜ / è¼‰å…¥ï¼šæœƒè¨˜ä½æ‰€æœ‰ä½ç½®èˆ‡é¡è‰²</li>
    </ul>
    <button onclick="help.style.display='none'">é—œé–‰</button>
  </div>
</div>

<script>
const canvas=c=document.getElementById('c'),ctx=c.getContext('2d');
resize();window.onresize=resize;
function resize(){c.width=innerWidth;c.height=innerHeight}

const COLORS={
  tree:cTree.value,ribbon:cRibbon.value,ball:cBall.value,
  gift:cGift.value,star:cStar.value
};

[cTree,cRibbon,cBall,cGift,cStar].forEach(i=>{
  i.oninput=e=>{COLORS[i.id.slice(1).toLowerCase()]=e.target.value;render();};
});

let balls=[],gifts=[];
let ribbons=[{y:-80},{y:0},{y:80}];
let history=[],redoStack=[],selected=null;

function snapshot(){
  history.push(JSON.stringify({balls,gifts,ribbons,COLORS}));
  redoStack=[];
}

function restore(s){
  const d=JSON.parse(s);
  balls=d.balls;gifts=d.gifts;ribbons=d.ribbons;
  Object.assign(COLORS,d.COLORS);
  render();
}

function render(){
  ctx.clearRect(0,0,c.width,c.height);
  drawSnow();
  drawTree();
  drawRibbons();
  drawBalls();
  drawGifts();
  drawStar();
}

function drawTree(){
  ctx.fillStyle=COLORS.tree;
  [120,80,40].forEach((w,i)=>{
    ctx.beginPath();
    ctx.ellipse(c.width/2,200+i*70,w,30,0,0,Math.PI*2);
    ctx.fill();
  });
  ctx.fillStyle="#8b5a2b";
  ctx.fillRect(c.width/2-20,240,40,120);
}

function drawRibbons(){
  ctx.strokeStyle=COLORS.ribbon;
  ctx.lineWidth=6;
  ribbons.forEach(r=>{
    ctx.beginPath();
    ctx.moveTo(c.width/2-140,200+r.y);
    ctx.lineTo(c.width/2+140,200+r.y);
    ctx.stroke();
  });
}

function drawBalls(){
  ctx.fillStyle=COLORS.ball;
  balls.forEach(b=>{
    ctx.beginPath();
    ctx.arc(b.x,b.y,8,0,Math.PI*2);
    ctx.fill();
  });
}

function drawGifts(){
  gifts.forEach(g=>{
    ctx.fillStyle=COLORS.gift;
    ctx.fillRect(g.x-14,g.y-10,28,20);
    ctx.fillStyle="#ffd966";
    ctx.fillRect(g.x-2,g.y-10,4,20);
  });
}

function drawStar(){
  const x=c.width/2,y=120,r=14;
  ctx.fillStyle=COLORS.star;
  ctx.beginPath();
  for(let i=0;i<5;i++){
    ctx.lineTo(
      x+Math.cos((18+i*72)/180*Math.PI)*r,
      y-Math.sin((18+i*72)/180*Math.PI)*r
    );
    ctx.lineTo(
      x+Math.cos((54+i*72)/180*Math.PI)*r/2,
      y-Math.sin((54+i*72)/180*Math.PI)*r/2
    );
  }
  ctx.closePath();ctx.fill();
}

let snow=[...Array(120)].map(()=>({
  x:Math.random()*c.width,y:Math.random()*c.height,s:Math.random()*1.5
}));
function drawSnow(){
  ctx.fillStyle="#fff";
  snow.forEach(f=>{
    ctx.beginPath();ctx.arc(f.x,f.y,f.s,0,Math.PI*2);ctx.fill();
    f.y+=0.3;if(f.y>c.height)f.y=0;
  });
}

canvas.onclick=e=>{
  snapshot();
  balls.push({x:e.offsetX,y:e.offsetY});
  render();
};

addGift.onclick=()=>{
  snapshot();
  gifts.push({x:c.width/2,y:380});
  render();
};

undo.onclick=()=>{if(history.length){redoStack.push(JSON.stringify({balls,gifts,ribbons,COLORS}));restore(history.pop());}};
redo.onclick=()=>{if(redoStack.length){history.push(JSON.stringify({balls,gifts,ribbons,COLORS}));restore(redoStack.pop());}};

document.onkeydown=e=>{
  if(e.key==="z"&&e.ctrlKey)undo.onclick();
  if(e.key==="y"&&e.ctrlKey)redo.onclick();
};

helpBtn.onclick=()=>help.style.display='flex';

function updateSlots(){
  slot.innerHTML="";
  for(let i=0;i<5;i++){
    const o=document.createElement("option");
    o.value=i;o.text="å­˜æª” "+(i+1);
    slot.appendChild(o);
  }
}
updateSlots();

save.onclick=()=>{
  localStorage.setItem("tree_"+slot.value,JSON.stringify({balls,gifts,ribbons,COLORS}));
};
load.onclick=()=>{
  const d=localStorage.getItem("tree_"+slot.value);
  if(d)restore(d);
};

export.onclick=()=>{
  const a=document.createElement("a");
  a.href=c.toDataURL("image/png");
  a.download="tree.png";a.click();
};

render();
</script>
</body>
</html>
