<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ„ è–èª•æ¨¹è£é£¾å™¨ï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;padding:0;background:#0b1d3a;overflow:hidden;font-family:system-ui}
canvas{display:block}

.panel{
  position:fixed;left:14px;top:14px;
  background:rgba(20,30,50,.85);
  padding:14px;
  border-radius:14px;
  color:white;
  font-size:13px;
  z-index:10;
  width:200px;
}
.panel label{display:block;margin-top:6px}
.panel input[type=color]{float:right}

.topbar{
  position:fixed;right:14px;top:14px;
  z-index:10;
}
.topbar button{
  margin-left:6px;
  border:none;
  border-radius:8px;
  padding:6px 10px;
  cursor:pointer;
}

.help{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  z-index:20;
}
.help .box{
  background:white;
  color:#333;
  max-width:520px;
  margin:60px auto;
  padding:20px;
  border-radius:12px;
}
</style>
</head>
<body>

<div class="panel">
<b>ğŸ¨ é¡è‰²èª¿æ•´</b>
<label>ğŸŒ² æ¨¹è‘‰ <input type="color" id="cLeaf" value="#1f6b45"></label>
<label>ğŸ€ å½©å¸¶ <input type="color" id="cRibbon" value="#d4af37"></label>
<label>ğŸ€ è´è¶çµ <input type="color" id="cBow" value="#f4d03f"></label>
<label>ğŸ”´ å°çƒ <input type="color" id="cBall" value="#c0392b"></label>
<label>ğŸ ç¦®ç‰© <input type="color" id="cGift" value="#ff6fae"></label>
<label>â­ æ˜Ÿæ˜Ÿ <input type="color" id="cStar" value="#fff2a8"></label>
<hr>
<button onclick="addGift()">â• æ–°å¢ç¦®ç‰©</button>
<hr>
<select id="saveSelect"></select>
<button onclick="saveDesign()">ğŸ’¾ å„²å­˜</button>
<button onclick="loadDesign()">ğŸ“‚ è¼‰å…¥</button>
</div>

<div class="topbar">
<button onclick="undo()">â†¶</button>
<button onclick="redo()">â†·</button>
<button onclick="exportPNG()">ğŸ“¸</button>
<button onclick="showHelp()">â“ ä½¿ç”¨èªªæ˜</button>
</div>

<div class="help" id="help">
  <div class="box">
    <h3>ä½¿ç”¨èªªæ˜</h3>
    <ul>
      <li>é»ç•«é¢æ–°å¢ ğŸ”´ å°çƒ</li>
      <li>æ‹–æ›³ç‰©ä»¶ç§»å‹•</li>
      <li>é¸å–å¾ŒæŒ‰ Backspace åˆªé™¤</li>
      <li>å½©å¸¶é è¿‘æ­£ç¢ºä½ç½®æœƒå¸é™„</li>
      <li>Ctrl+Z / Ctrl+Y å¯å¾©åŸé‡åš</li>
      <li>å¯å„²å­˜å¤šå€‹è¨­è¨ˆ</li>
    </ul>
    <button onclick="hideHelp()">é—œé–‰</button>
  </div>
</div>

<canvas id="c"></canvas>

<script>
/* ===== Canvas ===== */
const c=document.getElementById("c"),ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight}
addEventListener("resize",resize);resize();
const CX=()=>c.width/2;

/* ===== State ===== */
let state={
  balls:[],
  gifts:[],
  ribbons:[0,1,2],
  colors:{
    leaf:cLeaf.value,
    ribbon:cRibbon.value,
    bow:cBow.value,
    ball:cBall.value,
    gift:cGift.value,
    star:cStar.value
  }
};

let undoStack=[],redoStack=[],selected=null;

/* ===== Tree ===== */
const TREE={
  top:160,
  gap:85,
  layers:[
    {w:240,h:120},
    {w:340,h:135},
    {w:460,h:150}
  ]
};


/* ===== Snow ===== */
const snow=Array.from({length:150},()=>({
  x:Math.random()*c.width,
  y:Math.random()*c.height,
  r:Math.random()*2+1,
  s:Math.random()*0.4+0.2
}));

/* ===== Utilities ===== */
function pushUndo(){
  undoStack.push(JSON.stringify(state));
  redoStack=[];
}
function undo(){
  if(!undoStack.length)return;
  redoStack.push(JSON.stringify(state));
  state=JSON.parse(undoStack.pop());
}
function redo(){
  if(!redoStack.length)return;
  undoStack.push(JSON.stringify(state));
  state=JSON.parse(redoStack.pop());
}

/* ===== Draw ===== */
let starT=0;
function draw(){
  ctx.clearRect(0,0,c.width,c.height);

  // snow
  ctx.fillStyle="white";
  snow.forEach(s=>{
    s.y+=s.s;
    if(s.y>c.height){s.y=-5;s.x=Math.random()*c.width}
    ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  });

  // star
  starT+=0.05;
  ctx.save();
  ctx.fillStyle=state.colors.star;
  ctx.shadowColor=state.colors.star;
  ctx.shadowBlur=15+Math.sin(starT)*6;
  drawStar(CX(),TREE.top-TREE.layers[0].h+6,18,8);
  ctx.restore();

  // tree
  ctx.fillStyle=state.colors.leaf;
  TREE.layers.forEach((l,i)=>{
    const y=TREE.top+i*TREE.gap;
    ctx.beginPath();
    ctx.moveTo(CX()-l.w/2,y);
    ctx.quadraticCurveTo(CX(),y-l.h,CX()+l.w/2,y);
    ctx.quadraticCurveTo(CX(),y+l.h,CX()-l.w/2,y);
    ctx.fill();
  });

  // ribbons
  ctx.strokeStyle=state.colors.ribbon;
  ctx.lineWidth=8;ctx.lineCap="round";
  state.ribbons.forEach(i=>{
    const l=TREE.layers[i];
    const y=TREE.top+i*TREE.gap+10;
    ctx.beginPath();
    ctx.moveTo(CX()-l.w/2+20,y);
    ctx.quadraticCurveTo(CX(),y-25,CX()+l.w/2-20,y);
    ctx.stroke();
  });

  // trunk
  ctx.fillStyle="#8b5a2b";
  ctx.fillRect(CX()-22,TREE.top+TREE.gap*2+40,44,110);

  // balls
  ctx.fillStyle=state.colors.ball;
  state.balls.forEach(b=>{
    ctx.beginPath();ctx.arc(b.x,b.y,8,0,Math.PI*2);ctx.fill();
  });

  // gifts
  state.gifts.forEach(g=>{
    ctx.fillStyle=state.colors.gift;
    ctx.fillRect(g.x-20,g.y,40,30);
    drawBow(g.x,g.y-4);
  });

  requestAnimationFrame(draw);
}
draw();

/* ===== Shapes ===== */
function drawStar(cx,cy,o,i){
  ctx.beginPath();
  for(let k=0;k<10;k++){
    const r=k%2?i:o;
    const a=Math.PI/2+k*Math.PI/5;
    ctx.lineTo(cx+Math.cos(a)*r,cy-Math.sin(a)*r);
  }
  ctx.closePath();ctx.fill();
}
function drawBow(x,y){
  ctx.fillStyle=state.colors.bow;
  ctx.beginPath();ctx.ellipse(x-6,y,6,4,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(x+6,y,6,4,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(x,y,3,0,Math.PI*2);ctx.fill();
}

/* ===== Interaction ===== */
c.onclick=e=>{
  pushUndo();
  state.balls.push({x:e.offsetX,y:e.offsetY});
};
function addGift(){
  pushUndo();
  state.gifts.push({x:CX(),y:TREE.top+TREE.gap*2+80});
}

/* ===== Save / Load ===== */
function refreshSelect(){
  saveSelect.innerHTML="";
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith("tree-")){
      const o=document.createElement("option");
      o.value=k;o.text=k.replace("tree-","");
      saveSelect.appendChild(o);
    }
  });
}
function saveDesign(){
  const name=prompt("å­˜æª”åç¨±");
  if(!name)return;
  localStorage.setItem("tree-"+name,JSON.stringify(state));
  refreshSelect();
}
function loadDesign(){
  const k=saveSelect.value;
  if(!k)return;
  state=JSON.parse(localStorage.getItem(k));
}
refreshSelect();

/* ===== Help ===== */
function showHelp(){help.style.display="block"}
function hideHelp(){help.style.display="none"}

/* ===== Shortcuts ===== */
addEventListener("keydown",e=>{
  if(e.ctrlKey&&e.key==="z")undo();
  if(e.ctrlKey&&e.key==="y")redo();
});
</script>
</body>
</html>
