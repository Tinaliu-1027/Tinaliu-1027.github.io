<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tina æ­£éŸ³ç­ï½œæ‰‹æ©ŸéŒ„éŸ³ç¤ºç¯„</title>
<style>
body{font-family:"Microsoft JhengHei",sans-serif;background:#fdf6f0;margin:0;padding:0}
header{background:#ffb6b9;color:#fff;padding:20px;text-align:center;font-size:26px;font-weight:bold}
main{max-width:900px;margin:auto;padding:20px}
h2{color:#ff4c4c}
.levels button{margin:5px;padding:10px 18px;border:none;background:#ffb6b9;color:#fff;border-radius:6px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:20px;position:relative}
audio{width:100%;margin-top:8px}
.lock{background:#ffe0e0;padding:12px;border-radius:10px;margin-top:30px}
footer{text-align:center;padding:15px;background:#ffb6b9;color:white}
</style>
</head>
<body>

<header>ğŸ¤ Tina æ­£éŸ³ç­ï½œæ‰‹æ©ŸéŒ„éŸ³ç¤ºç¯„</header>
<main>

<h2>åˆ†ç´šæŒ‘æˆ°</h2>
<div class="levels">
  <button onclick="show('easy')">ç°¡å–®</button>
  <button onclick="show('medium')">ä¸­ç­‰</button>
  <button onclick="show('hard')">å›°é›£</button>
</div>
<div id="list"></div>

<h2>ğŸ”’ Tina ä¸Šå‚³ç¤ºç¯„éŸ³</h2>
<div class="lock">
<input type="password" id="pwd" placeholder="è¼¸å…¥å¯†ç¢¼">
<button onclick="unlock()">è§£é–</button>
<div id="teacher" style="display:none">
<p>GitHub Tokenï¼š</p>
<input type="text" id="token" placeholder="è¼¸å…¥ GitHub Token" style="width:100%">
<p>é›£åº¦ï¼š
<select id="newLevel">
<option value="easy">ç°¡å–®</option>
<option value="medium">ä¸­ç­‰</option>
<option value="hard">å›°é›£</option>
</select></p>

<textarea id="newText" placeholder="è¼¸å…¥ç¹å£ä»¤" rows="3" style="width:100%"></textarea>

<p>æ‰‹æ©ŸéŒ„éŸ³ï¼š</p>
<button onclick="startRec()">ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
<button onclick="stopRec()">â¹ åœæ­¢éŒ„éŸ³</button>
<br><br>
<a id="uploadLink" style="display:none"></a>
</div>
</div>

</main>
<footer>Â© Tina æ­£éŸ³ç­</footer>

<script>
// åˆ†ç´šè³‡æ–™
let data={easy:[],medium:[],hard:[]};
let current="easy";

// é¡¯ç¤ºç¹å£ä»¤
function show(level){
  current=level;
  const list=document.getElementById("list");
  list.innerHTML="";
  data[level].forEach(t=>{
    list.innerHTML+=`
      <div class="card">
        <p>${t.text}</p>
        <p>ğŸ§ Tina ç¤ºç¯„</p>
        ${t.demo?`<audio controls src="${t.demo}"></audio>
        <a href="${t.demo}" download="${t.text}.mp3">â¬‡ï¸ ä¸‹è¼‰ç¤ºç¯„éŸ³</a>`:`<p>å°šç„¡ç¤ºç¯„éŸ³</p>`}
        <p>ğŸ¤ å­¸å“¡éŒ„éŸ³</p>
        <input type="file" accept="audio/*" onchange="playStudent(event,this)">
      </div>
    `;
  });
}

// å­¸å“¡æ’­æ”¾éŒ„éŸ³
function playStudent(e,input){
  const a=document.createElement("audio");
  a.controls=true;
  a.src=URL.createObjectURL(e.target.files[0]);
  input.after(a);
}

// Tina å¯†ç¢¼è§£é–
function unlock(){
  if(document.getElementById("pwd").value==="981027"){
    document.getElementById("teacher").style.display="block";
  } else alert("å¯†ç¢¼éŒ¯èª¤");
}

// Tina æ‰‹æ©ŸéŒ„éŸ³
let rec,chunks=[];
async function startRec(){
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  rec = new MediaRecorder(stream);
  chunks=[];
  rec.ondataavailable = e => chunks.push(e.data);
  rec.start();
  alert("éŒ„éŸ³é–‹å§‹ï¼");
}

// åœæ­¢éŒ„éŸ³ä¸¦ä¸Šå‚³ GitHub
async function stopRec(){
  rec.onstop = async ()=>{
    const blob = new Blob(chunks,{type:'audio/mp3'});
    const file = new File([blob],'demo.mp3',{type:'audio/mp3'});

    const token = document.getElementById("token").value.trim();
    if(!token){alert("è«‹å…ˆè¼¸å…¥ GitHub Token");return;}

    const repo = "Tinaliu-1027/TinaDemoToken"; // âš ï¸ æ”¹æˆä½ çš„ GitHub Repo
    const path = "demo"; // å­˜æ”¾è·¯å¾‘

    try{
      const url = await uploadToGitHub(file, path, token, repo);
      alert("ä¸Šå‚³æˆåŠŸï¼");
      const lv=document.getElementById("newLevel").value;
      const text=document.getElementById("newText").value.trim();
      data[lv].push({text:text,demo:url});
      show(lv);
    }catch(e){
      alert("ä¸Šå‚³å¤±æ•—ï¼š"+e.message);
    }
  }
  rec.stop();
}

// å°‡ Blob è½‰ Base64
function blobToBase64(blob){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onloadend=()=>resolve(reader.result.split(',')[1]);
    reader.onerror=reject;
    reader.readAsDataURL(blob);
  });
}

// ä¸Šå‚³åˆ° GitHub
async function uploadToGitHub(file,path,token,repo){
  const base64 = await blobToBase64(file);
  const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}/${file.name}`,{
    method:"PUT",
    headers:{
      "Authorization":"token "+token,
      "Content-Type":"application/json"
    },
    body:JSON.stringify({
      message:"æ–°å¢ Tina ç¤ºç¯„éŸ³",
      content:base64
    })
  });
  const data = await res.json();
  if(data.content && data.content.download_url) return data.content.download_url;
  else throw new Error("ä¸Šå‚³å¤±æ•—");
}

</script>

</body>
</html>
