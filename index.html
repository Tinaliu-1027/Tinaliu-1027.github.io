<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ„ è–èª•æ¨¹è¨­è¨ˆå™¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:#0b1d3a;
  overflow:hidden;
  font-family:system-ui,-apple-system,sans-serif;
  color:white;
}
canvas{display:block}

/* å·¦å´æ§åˆ¶ */
.controls{
  position:fixed;
  left:20px;
  top:20px;
  width:240px;
  background:rgba(20,30,50,.88);
  padding:16px;
  border-radius:16px;
  z-index:10;
}
.controls h3{margin:10px 0 6px;font-size:15px}
.controls label{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
  margin:6px 0
}
.controls input[type=color]{width:40px;height:24px;border:none}
.controls button,select{
  width:100%;
  margin-top:6px;
  padding:6px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}

/* å³ä¸Š */
.top-right{
  position:fixed;
  right:20px;
  top:20px;
  z-index:10;
}
.top-right button{
  margin-left:6px;
  padding:6px 10px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}

/* ä½¿ç”¨èªªæ˜è¦–çª— */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99;
}
.modal-content{
  background:#1b2b4a;
  width:min(90%,520px);
  max-height:80vh;
  overflow:auto;
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
}
.modal-content h2{
  margin-top:0;
  text-align:center;
}
.modal-content ul{
  padding-left:18px;
  line-height:1.7;
}
.close{
  text-align:center;
  margin-top:12px;
}
.close button{
  padding:6px 16px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- å·¦å´ -->
<div class="controls">
  <h3>ğŸ¨ é¡è‰²è¨­å®š</h3>
  <label>ğŸŒ² æ¨¹è‘‰ <input type="color" id="leaf"></label>
  <label>ğŸ€ å½©å¸¶ <input type="color" id="ribbon"></label>
  <label>ğŸ”´ å°çƒ <input type="color" id="ball"></label>
  <label>ğŸ ç¦®ç‰© <input type="color" id="gift"></label>
  <label>â­ æ˜Ÿæ˜Ÿ <input type="color" id="star"></label>

  <h3>ğŸ ç¦®ç‰©</h3>
  <button id="addGift">â• æ–°å¢ç¦®ç‰©</button>

  <h3>ğŸ“¸ åŒ¯å‡º</h3>
  <button onclick="exportPNG()">ğŸ“¸ åŒ¯å‡º PNG</button>
</div>

<!-- å³ä¸Š -->
<div class="top-right">
  <button onclick="undo()">â†¶</button>
  <button onclick="redoFn()">â†·</button>
  <button onclick="openHelp()">ğŸ“˜ ä½¿ç”¨èªªæ˜</button>
</div>

<!-- ä½¿ç”¨èªªæ˜ -->
<div class="modal" id="helpModal">
  <div class="modal-content">
    <h2>ğŸ„ è–èª•æ¨¹è¨­è¨ˆå™¨ï¼ä½¿ç”¨èªªæ˜</h2>
    <ul>
      <li><b>æ–°å¢å°çƒï¼š</b>åœ¨æ¨¹ä¸Šä»»æ„ä½ç½®é»ä¸€ä¸‹</li>
      <li><b>æ–°å¢ç¦®ç‰©ï¼š</b>é»æ“Šã€Œâ• æ–°å¢ç¦®ç‰©ã€</li>
      <li><b>æ‹–æ›³ç‰©ä»¶ï¼š</b>æ»‘é¼ æˆ–æ‰‹æŒ‡ç›´æ¥æ‹–</li>
      <li><b>é¸å–ç‰©ä»¶ï¼š</b>é»ä¸€ä¸‹æœƒå‡ºç¾è—è‰²é¸å–æ¡†</li>
      <li><b>åˆªé™¤ç‰©ä»¶ï¼š</b>é¸å–å¾ŒæŒ‰ Delete / Backspace</li>
      <li><b>å½©å¸¶å¸é™„ï¼š</b>æ‹–æ›³æ™‚å‡ºç¾è¼”åŠ©ç·šï¼Œæ”¾æ‰‹è‡ªå‹•å°é½Š</li>
      <li><b>å¾©åŸ / é‡åšï¼š</b>Ctrl+Z / Ctrl+Y æˆ–å³ä¸ŠæŒ‰éˆ•</li>
      <li><b>é¡è‰²èª¿æ•´ï¼š</b>å·¦å´è‰²ç¥¨å³æ™‚æ”¹è®Š</li>
      <li><b>åŒ¯å‡ºåœ–ç‰‡ï¼š</b>é»ã€ŒğŸ“¸ åŒ¯å‡º PNGã€</li>
    </ul>
    <div class="close">
      <button onclick="closeHelp()">é—œé–‰</button>
    </div>
  </div>
</div>

<canvas id="c"></canvas>

<script>
const canvas=c,ctx=c.getContext("2d");
const CX=()=>canvas.width/2;
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();addEventListener("resize",resize);

// èªªæ˜è¦–çª—
function openHelp(){helpModal.style.display="flex"}
function closeHelp(){helpModal.style.display="none"}

// é¡è‰²
const colors={leaf:"#1f6b45",ribbon:"#d4af37",ball:"#c0392b",gift:"#ff6fae",star:"#fff2a8"};
Object.keys(colors).forEach(k=>{
  const e=document.getElementById(k);
  e.value=colors[k];
  e.oninput=()=>colors[k]=e.value;
});

// è³‡æ–™
let balls=[],ribbons=[{y:260},{y:310},{y:360}],gifts=[];
let selected=null,dragging=null;

// æ­·å²
let history=[],redo=[];
function saveState(){history.push(JSON.stringify({balls,ribbons,gifts,colors}));redo=[]}
saveState();

// æ“ä½œ
canvas.onmousedown=e=>down(e.offsetX,e.offsetY);
canvas.onmousemove=e=>move(e.offsetX,e.offsetY);
canvas.onmouseup=()=>dragging=null;

function down(x,y){
  selected=null;
  balls.forEach(o=>{if(Math.hypot(x-(CX()+o.x),y-o.y)<o.r+6){selected=o;dragging=o}});
  gifts.forEach(o=>{if(x> CX()+o.x-20&&x<CX()+o.x+20&&y>o.y&&y<o.y+30){selected=o;dragging=o}});
  ribbons.forEach(o=>{if(Math.abs(y-o.y)<10){selected=o;dragging=o}});
  if(!selected && y>200&&y<380){
    balls.push({x:x-CX(),y,r:9});
    saveState();
  }
}

function move(x,y){
  if(!dragging)return;
  if("r" in dragging){dragging.x=x-CX();dragging.y=y}
  else dragging.y=Math.round(y/10)*10;
}

// éµç›¤
addEventListener("keydown",e=>{
  if((e.key==="Delete"||e.key==="Backspace")&&selected){
    [balls,ribbons,gifts].forEach(a=>{
      const i=a.indexOf(selected);if(i>-1)a.splice(i,1)
    });
    selected=null;saveState();
  }
  if(e.ctrlKey&&e.key==="z")undo();
  if(e.ctrlKey&&e.key==="y")redoFn();
});

function undo(){if(history.length<2)return;redo.push(history.pop());load(history.at(-1))}
function redoFn(){if(!redo.length)return;const s=redo.pop();history.push(s);load(s)}
function load(s){const d=JSON.parse(s);balls=d.balls;ribbons=d.ribbons;gifts=d.gifts;Object.assign(colors,d.colors)}

addGift.onclick=()=>{gifts.push({x:0,y:460});saveState()};

// åŒ¯å‡º
function exportPNG(){
  const a=document.createElement("a");
  a.download="christmas-tree.png";
  a.href=canvas.toDataURL();
  a.click();
}

// é›ª
const snow=Array.from({length:150},()=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:Math.random()*2+1,s:Math.random()*0.6+0.3}));

function leafLayer(y,w,h){
  ctx.fillStyle=colors.leaf;
  ctx.beginPath();
  ctx.moveTo(CX()-w/2,y);
  ctx.quadraticCurveTo(CX(),y-h,CX()+w/2,y);
  ctx.quadraticCurveTo(CX(),y+h*0.7,CX()-w/2,y);
  ctx.fill();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // æ˜Ÿæ˜Ÿ
  ctx.fillStyle=colors.star;
  ctx.beginPath();
  ctx.arc(CX(),150,10,0,Math.PI*2);
  ctx.fill();

  // æ¨¹
  leafLayer(200,220,60);
  leafLayer(255,280,70);
  leafLayer(320,340,80);

  // å½©å¸¶
  ctx.strokeStyle=colors.ribbon;
  ctx.lineWidth=4;
  ribbons.forEach(r=>{
    ctx.beginPath();
    ctx.moveTo(CX()-160,r.y);
    ctx.quadraticCurveTo(CX(),r.y-20,CX()+160,r.y);
    ctx.stroke();
  });

  // å°çƒ
  balls.forEach(b=>{
    ctx.fillStyle=colors.ball;
    ctx.beginPath();
    ctx.arc(CX()+b.x,b.y,b.r,0,Math.PI*2);
    ctx.fill();
  });

  // ç¦®ç‰©
  gifts.forEach(g=>{
    ctx.fillStyle=colors.gift;
    ctx.fillRect(CX()+g.x-20,g.y,40,30);
  });

  // é›ª
  ctx.fillStyle="white";
  snow.forEach(s=>{
    s.y+=s.s;if(s.y>canvas.height)s.y=0;
    ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  });

  // é¸å–æ¡†
  if(selected){
    ctx.strokeStyle="#00ffff";
    ctx.strokeRect(
      selected.x?CX()+selected.x-12:CX()-170,
      selected.y-12,24,24
    );
  }

  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
