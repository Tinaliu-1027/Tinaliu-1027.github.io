<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ„ è–èª•æ¨¹è£é£¾å™¨ï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:#0b1d3a;
  overflow:hidden;
  font-family:system-ui,-apple-system,sans-serif;
  color:white;
}
canvas{display:block}

/* å·¦å´é¢æ¿ */
.panel{
  position:fixed;
  left:16px; top:16px;
  width:230px;
  background:rgba(20,30,50,.9);
  padding:14px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  z-index:10;
  font-size:14px;
}
.panel h3{margin:0 0 8px;font-size:15px}
.panel label{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:6px 0;
}
.panel button, .panel select{
  width:100%;
  margin-top:6px;
  padding:6px;
  border-radius:8px;
  border:none;
}
.panel button{background:#ffd86b;cursor:pointer}

.top{
  position:fixed;
  right:16px; top:16px;
  z-index:10;
}
.top button{
  padding:6px 10px;
  border-radius:8px;
  border:none;
  background:#ffd86b;
  margin-left:4px;
}
</style>
</head>

<body>

<div class="panel">
  <h3>ğŸ¨ é¡è‰²è¨­å®š</h3>
  <label>ğŸŒ² æ¨¹è‘‰ <input type="color" id="leaf" value="#1f6b45"></label>
  <label>ğŸ€ å½©å¸¶ <input type="color" id="ribbon" value="#d4af37"></label>
  <label>ğŸ€ è´è¶çµ <input type="color" id="bow" value="#e6c76b"></label>
  <label>ğŸ”´ å°çƒ <input type="color" id="ball" value="#c0392b"></label>
  <label>ğŸ ç¦®ç‰© <input type="color" id="gift" value="#ff7fbf"></label>
  <label>â­ æ˜Ÿæ˜Ÿ <input type="color" id="star" value="#fff2a8"></label>

  <button id="addBall">â• æ–°å¢å°çƒ</button>

  <select id="saveList"></select>
  <button id="saveBtn">ğŸ’¾ å„²å­˜</button>
  <button id="loadBtn">ğŸ“‚ è¼‰å…¥</button>
  <button id="exportBtn">ğŸ“¸ åŒ¯å‡º PNG</button>
</div>

<div class="top">
  <button id="undoBtn">â†¶</button>
  <button id="redoBtn">â†·</button>
</div>

<canvas id="c"></canvas>

<script>
/* ========= åŸºæœ¬ ========= */
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
resize();addEventListener("resize",resize);
const CX=()=>canvas.width/2;
const scale=1.4;

/* ========= é¡è‰² ========= */
const colors={
  leaf:leaf.value,ribbon:ribbon.value,bow:bow.value,
  ball:ball.value,gift:gift.value,star:star.value
};
[leaf,ribbon,bow,ball,gift,star].forEach(i=>{
  i.oninput=()=>colors[i.id]=i.value;
});

/* ========= æ¨¹è‘‰å±¤ ========= */
const layers=[
  {y:200,w:180,h:60,c:30},
  {y:260,w:240,h:70,c:35},
  {y:320,w:300,h:80,c:40}
];

/* ========= å½©å¸¶ ========= */
let ribbons=layers.map((_,i)=>({layer:i,offset:0}));

/* ========= å°çƒ ========= */
let balls=[];

/* ========= ç¦®ç‰© ========= */
let gifts=[{x:-70,y:480},{x:0,y:480},{x:70,y:480}];

/* ========= é›ª ========= */
const snow=Array.from({length:150},()=>({
  x:Math.random()*innerWidth,
  y:Math.random()*innerHeight,
  r:Math.random()*2+1,
  s:Math.random()*0.6+0.3
}));

/* ========= æ­·å² ========= */
let history=[],redo=[];
function saveState(){
  history.push(JSON.stringify({balls,ribbons,gifts,colors}));
  if(history.length>50)history.shift();
  redo.length=0;
}
saveState();

/* ========= äº’å‹• ========= */
let drag=null,selected=null;
canvas.onmousedown=e=>{
  const mx=e.offsetX,my=e.offsetY;
  balls.forEach(b=>{
    if(Math.hypot(mx-(CX()+b.x),my-b.y*scale)<10*scale){drag=b;selected=b;}
  });
  ribbons.forEach(r=>{
    const y=(layers[r.layer].y+r.offset)*scale;
    if(Math.abs(my-y)<10){drag=r;selected=r;}
  });
  gifts.forEach(g=>{
    if(mx>CX()+g.x-20&&mx<CX()+g.x+20&&my>g.y&&my<g.y+30){drag=g;selected=g;}
  });
};
canvas.onmousemove=e=>{
  if(drag){
    if("x"in drag){drag.x=e.offsetX-CX();drag.y=e.offsetY/scale;}
    else{drag.offset=(e.offsetY/scale)-layers[drag.layer].y;}
  }
};
canvas.onmouseup=()=>{if(drag)saveState();drag=null;};

document.onkeydown=e=>{
  if(e.key==="Backspace"||e.key==="Delete"){
    if(selected){
      balls=balls.filter(b=>b!==selected);
      ribbons=ribbons.filter(r=>r!==selected);
      gifts=gifts.filter(g=>g!==selected);
      selected=null; saveState();
    }
  }
  if(e.ctrlKey&&e.key==="z")undo();
  if(e.ctrlKey&&(e.key==="y"||e.key==="Z"))redoFn();
};

function undo(){if(history.length>1){redo.push(history.pop());load(history.at(-1));}}
function redoFn(){if(redo.length){const s=redo.pop();history.push(s);load(s);}}
undoBtn.onclick=undo; redoBtn.onclick=redoFn;

function load(s){
  const d=JSON.parse(s);
  balls=d.balls; ribbons=d.ribbons; gifts=d.gifts;
  Object.assign(colors,d.colors);
}

addBall.onclick=()=>{
  balls.push({x:0,y:280});
  saveState();
};

/* ========= ç¹ªè£½ ========= */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* æ˜Ÿ */
  const top=layers[0];
  ctx.save();
  ctx.translate(CX(),(top.y-top.h-10)*scale);
  ctx.fillStyle=colors.star;
  ctx.beginPath();
  for(let i=0;i<5;i++){
    ctx.lineTo(Math.cos((18+i*72)*Math.PI/180)*14*scale,
               -Math.sin((18+i*72)*Math.PI/180)*14*scale);
    ctx.lineTo(Math.cos((54+i*72)*Math.PI/180)*6*scale,
               -Math.sin((54+i*72)*Math.PI/180)*6*scale);
  }
  ctx.fill(); ctx.restore();

  /* æ¨¹è‘‰ */
  layers.forEach(l=>{
    ctx.fillStyle=colors.leaf;
    const y=l.y*scale,w=l.w*scale,h=l.h*scale;
    ctx.beginPath();
    ctx.moveTo(CX()-w/2,y);
    ctx.quadraticCurveTo(CX(),y-h,CX()+w/2,y);
    ctx.quadraticCurveTo(CX(),y+h*0.7,CX()-w/2,y);
    ctx.fill();
  });

  /* å½©å¸¶ */
  ctx.strokeStyle=colors.ribbon;
  ctx.lineWidth=4;
  ribbons.forEach(r=>{
    const l=layers[r.layer];
    const y=(l.y+r.offset)*scale;
    const w=l.w*scale;
    ctx.beginPath();
    ctx.moveTo(CX()-w/2,y);
    ctx.quadraticCurveTo(CX(),y-l.c*scale,CX()+w/2,y);
    ctx.stroke();
  });

  /* æ¨¹å¹¹ */
  ctx.fillStyle="#8b5a2b";
  ctx.fillRect(CX()-15*scale,340*scale,30*scale,90*scale);

  /* å°çƒ */
  balls.forEach(b=>{
    ctx.fillStyle=colors.ball;
    ctx.beginPath();
    ctx.arc(CX()+b.x,b.y*scale,9*scale,0,Math.PI*2);
    ctx.fill();
  });

  /* ç¦®ç‰© */
  gifts.forEach(g=>{
    ctx.fillStyle=colors.gift;
    ctx.fillRect(CX()+g.x-18*scale,g.y,36*scale,26*scale);
    ctx.fillStyle=colors.bow;
    ctx.beginPath();
    ctx.ellipse(CX()+g.x-6*scale,g.y-3*scale,6*scale,4*scale,0,0,Math.PI*2);
    ctx.ellipse(CX()+g.x+6*scale,g.y-3*scale,6*scale,4*scale,0,0,Math.PI*2);
    ctx.fill();
  });

  /* é›ª */
  ctx.fillStyle="white";
  snow.forEach(s=>{
    s.y+=s.s; if(s.y>canvas.height)s.y=0;
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
  });

  requestAnimationFrame(draw);
}
draw();

exportBtn.onclick=()=>{
  const a=document.createElement("a");
  a.download="christmas-tree.png";
  a.href=canvas.toDataURL();
  a.click();
};
</script>
</body>
</html>
