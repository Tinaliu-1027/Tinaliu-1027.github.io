<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è£é£¾è–èª•æ¨¹</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:#0b1d3a;
  overflow:hidden;
  font-family:system-ui,-apple-system,sans-serif;
  color:white;
}
.controls{
  position:fixed;
  left:20px;
  top:20px;
  background:rgba(20,30,50,.85);
  padding:16px;
  border-radius:16px;
  z-index:10;
  font-size:14px;
}
.controls label{display:block;margin-top:6px}
.controls input,.controls select{
  width:100%;
  margin-top:4px;
}
button{
  margin-top:6px;
  padding:6px 10px;
  border-radius:8px;
  border:none;
  background:#ffd86b;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="controls">
  <strong>ğŸ„ è£é£¾è–èª•æ¨¹</strong>

  <label>å­˜æª”åç¨±
    <input id="saveName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç¬¬ä¸€æ£µæ¨¹">
  </label>

  <button onclick="saveDesign()">ğŸ’¾ å„²å­˜</button>

  <label>é¸æ“‡å­˜æª”
    <select id="saveList"></select>
  </label>

  <button onclick="loadDesign()">â–¶ï¸ è¼‰å…¥</button>
  <button onclick="deleteDesign()">ğŸ—‘ åˆªé™¤</button>
</div>

<canvas id="c"></canvas>

<script>
/* ===== Canvas ===== */
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
resize();addEventListener("resize",resize);
const CX=()=>canvas.width/2;

/* ===== ç‰©ä»¶ ===== */
const balls=[];
const ribbons=[
  {y:215,w:90},
  {y:255,w:120},
  {y:315,w:160}
];

/* ===== é›ª ===== */
const snow=Array.from({length:120},()=>({
  x:Math.random()*innerWidth,
  y:Math.random()*innerHeight,
  r:Math.random()*2+1,
  s:Math.random()*0.6+0.3
}));

/* ===== æ‹–æ›³ ===== */
let dragging=null;
function getPos(e){
  if(e.touches){
    const r=canvas.getBoundingClientRect();
    return {x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top};
  }
  return {x:e.offsetX,y:e.offsetY};
}

function start(e){
  const {x,y}=getPos(e);

  for(let i=ribbons.length-1;i>=0;i--){
    const r=ribbons[i];
    if(Math.abs(y-r.y)<10 && Math.abs(x-CX())<r.w){
      dragging=r;dragging.type="ribbon";return;
    }
  }

  for(let i=balls.length-1;i>=0;i--){
    const b=balls[i];
    if(Math.hypot(x-(CX()+b.x),y-b.y)<b.r){
      dragging=b;dragging.type="ball";return;
    }
  }

  balls.push({x:x-CX(),y:y,r:9});
}

function move(e){
  if(!dragging)return;
  const {x,y}=getPos(e);
  dragging.y=y;
  if(dragging.type==="ball") dragging.x=x-CX();
  e.preventDefault();
}
function end(){dragging=null;}

canvas.addEventListener("mousedown",start);
canvas.addEventListener("mousemove",move);
canvas.addEventListener("mouseup",end);
canvas.addEventListener("touchstart",start,{passive:false});
canvas.addEventListener("touchmove",move,{passive:false});
canvas.addEventListener("touchend",end);

/* ===== Backspace åˆªçƒ ===== */
addEventListener("keydown",e=>{
  if(e.key==="Backspace" && balls.length){
    balls.pop();
    e.preventDefault();
  }
});

/* ===== å„²å­˜ç³»çµ± ===== */
const saveInput=document.getElementById("saveName");
const saveList=document.getElementById("saveList");

function refreshSaveList(){
  saveList.innerHTML="";
  Object.keys(localStorage)
    .filter(k=>k.startsWith("tree_"))
    .forEach(k=>{
      const opt=document.createElement("option");
      opt.value=k;
      opt.textContent=k.replace("tree_","");
      saveList.appendChild(opt);
    });
}
refreshSaveList();

function saveDesign(){
  const name=saveInput.value.trim();
  if(!name){alert("è«‹è¼¸å…¥å­˜æª”åç¨±");return;}
  localStorage.setItem("tree_"+name,JSON.stringify({
    balls,ribbons
  }));
  refreshSaveList();
}

function loadDesign(){
  if(!saveList.value)return;
  const data=JSON.parse(localStorage.getItem(saveList.value));
  balls.length=0;
  data.balls.forEach(b=>balls.push(b));
  data.ribbons.forEach((r,i)=>ribbons[i].y=r.y);
}

function deleteDesign(){
  if(!saveList.value)return;
  localStorage.removeItem(saveList.value);
  refreshSaveList();
}

/* ===== ç•«åœ– ===== */
function leafLayer(y,w,h){
  ctx.fillStyle="#1f6b45";
  ctx.beginPath();
  ctx.moveTo(CX()-w/2,y);
  ctx.quadraticCurveTo(CX(),y-h,CX()+w/2,y);
  ctx.quadraticCurveTo(CX(),y+h*0.7,CX()-w/2,y);
  ctx.fill();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // æ¨¹å¹¹
  ctx.fillStyle="#8b5a2b";
  ctx.fillRect(CX()-18,300,36,160);

  // æ¨¹è‘‰
  leafLayer(190,160,50);
  leafLayer(245,230,65);
  leafLayer(310,300,80);

  // å½©å¸¶
  ctx.strokeStyle="#d4af37";
  ctx.lineWidth=4;
  ribbons.forEach(r=>{
    ctx.beginPath();
    ctx.moveTo(CX()-r.w,r.y);
    ctx.quadraticCurveTo(CX(),r.y-18,CX()+r.w,r.y);
    ctx.stroke();
  });

  // å°çƒ
  balls.forEach(b=>{
    ctx.fillStyle="#c0392b";
    ctx.beginPath();
    ctx.arc(CX()+b.x,b.y,b.r,0,Math.PI*2);
    ctx.fill();
  });

  // é›ª
  ctx.fillStyle="white";
  snow.forEach(s=>{
    s.y+=s.s;if(s.y>canvas.height)s.y=0;
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
    ctx.fill();
  });

  requestAnimationFrame(draw);
}
draw();
</script>

</body>
</html>
