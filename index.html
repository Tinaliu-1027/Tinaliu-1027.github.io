<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tina æ­£éŸ³ç­ - æ‰‹æ©Ÿç‰ˆ</title>
<style>
body { font-family:'Microsoft JhengHei'; background:#fdf6f0; margin:0; padding:20px;}
header { background:#ffb6b9; padding:20px; text-align:center; color:white; font-size:2em; font-weight:bold;}
nav { display:flex; justify-content:center; flex-wrap:wrap; background:#ffe0e0; padding:10px 0;}
nav a { margin:5px 15px; text-decoration:none; color:#333; font-weight:bold;}
nav a:hover { color:#ff4c4c; }
main { padding:20px; max-width:800px; margin:auto;}
h2 { color:#ff4c4c; }
.tongue-twister { background:#fff4f4; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.tongue-twister audio { margin-top:10px; width:100%; }
.feedback { margin-top:5px; color:#ff4c4c; font-weight:bold;}
button { margin:5px 0; padding:10px 20px; border:none; border-radius:5px; background:#ffb6b9; color:white; font-weight:bold; cursor:pointer;}
button:hover { background:#ff4c4c; }
footer { text-align:center; padding:15px; background:#ffb6b9; color:white; margin-top:30px;}
@media(max-width:500px){ nav{flex-direction:column;} button{width:80%; }}
</style>
</head>
<body>

<header>Tina æ­£éŸ³ç­</header>
<nav>
    <a href="#home">é¦–é </a>
    <a href="#manage">æ–°å¢ç¹å£ä»¤ï¼ˆåƒ… Tinaï¼‰</a>
    <a href="#list">ç¹å£ä»¤åˆ—è¡¨</a>
</nav>

<main id="home">
    <h2>æ­¡è¿ä¾†åˆ° Tina æ­£éŸ³ç­ï¼</h2>
    <p>ä½ å¯ä»¥æ–°å¢ç¹å£ä»¤èˆ‡ Tina ç¤ºç¯„éŸ³æª”ï¼Œå­¸å“¡å¯ä»¥ä¸Šå‚³è‡ªå·±çš„éŒ„éŸ³ä¸¦å³æ™‚æ¯”å°ç™¼éŸ³ï¼</p>
</main>

<!-- Tina ä¸Šå‚³å€ï¼Œå¯†ç¢¼é– -->
<main id="manage">
    <h2>æ–°å¢ç¹å£ä»¤ï¼ˆåƒ… Tinaï¼‰</h2>
    <label>è¼¸å…¥å¯†ç¢¼è§£é–ä¸Šå‚³å€ï¼š</label>
    <input type="password" id="tinaPasswordInput" placeholder="è¼¸å…¥å¯†ç¢¼">
    <button onclick="checkTinaPassword()">ç¢ºèª</button>

    <div id="tinaUploadSection" style="display:none; margin-top:10px;">
        <label>é¸æ“‡é›£åº¦ï¼š</label>
        <select id="levelSelect">
            <option value="easy">ç°¡å–®</option>
            <option value="medium">ä¸­ç­‰</option>
            <option value="hard">å›°é›£</option>
        </select>
        <br><br>
        <label>ç¹å£ä»¤æ–‡å­—ï¼š</label><br>
        <textarea id="twisterText" rows="2" style="width:100%;"></textarea>
        <br><br>
        <label>Tina ç¤ºç¯„éŒ„éŸ³ï¼ˆå¯è‡ªè¨‚æª”åï¼‰ï¼š</label>
        <input type="file" id="twisterTinaAudio" accept="audio/*">
        <input type="text" id="tinaFileName" placeholder="è¼¸å…¥ Tina éŸ³æª”æª”å">
        <br><br>
        <button onclick="addTwister()">æ–°å¢ç¹å£ä»¤</button>
    </div>
</main>

<main id="list">
    <h2>ç¹å£ä»¤åˆ—è¡¨</h2>
    <div id="twisterContainer"></div>
</main>

<footer>Â© 2025 Tina æ­£éŸ³ç­</footer>

<script>
// å¯†ç¢¼é–
function checkTinaPassword(){
    const pwd = document.getElementById('tinaPasswordInput').value;
    if(pwd === "981027"){
        document.getElementById('tinaUploadSection').style.display = "block";
        document.getElementById('tinaPasswordInput').style.display = "none";
        document.querySelector("#manage button").style.display = "none";
    } else {
        alert("å¯†ç¢¼éŒ¯èª¤ï¼");
    }
}

// è³‡æ–™çµæ§‹
let tongueTwisters = {
    easy: [],
    medium: [],
    hard: []
};

// é¡¯ç¤ºç¹å£ä»¤
function renderTwisters() {
    const container = document.getElementById('twisterContainer');
    container.innerHTML = '';
    ['easy','medium','hard'].forEach(level=>{
        if(tongueTwisters[level].length > 0){
            const h = document.createElement('h3');
            h.textContent = level === 'easy' ? 'ç°¡å–®' : level === 'medium' ? 'ä¸­ç­‰' : 'å›°é›£';
            container.appendChild(h);
        }
        tongueTwisters[level].forEach((tt,index)=>{
            const div = document.createElement('div');
            div.className = 'tongue-twister';
            let html = `<p>${tt.text}</p>`;
            // Tina ç¤ºç¯„éŸ³æª”æ’­æ”¾ï¼ˆå­¸å“¡å¯çœ‹ï¼‰
            if(tt.tinaAudio){
                html += `<p>Tina ç¤ºç¯„ (${tt.tinaFileName}):</p>
                         <audio controls src="${tt.tinaAudio}"></audio>`;
            }
            // å­¸å“¡éŒ„éŸ³ä¸Šå‚³å€
            html += `<p>ä¸Šå‚³ä½ çš„éŒ„éŸ³ï¼š</p>
                     <input type="file" accept="audio/*" onchange="uploadStudentAudio(event,'${level}',${index})">
                     <div id="studentAudio-${level}-${index}"></div>
                     <div class="feedback" id="feedback-${level}-${index}"></div>`;
            div.innerHTML = html;
            container.appendChild(div);
        });
    });
}

// æ–°å¢ç¹å£ä»¤ï¼ˆåƒ… Tinaï¼‰
function addTwister(){
    const level = document.getElementById('levelSelect').value;
    const text = document.getElementById('twisterText').value.trim();
    const fileInput = document.getElementById('twisterTinaAudio');
    const fileNameInput = document.getElementById('tinaFileName').value.trim();
    
    if(!text){ alert("è«‹è¼¸å…¥ç¹å£ä»¤æ–‡å­—"); return; }
    
    let tinaAudioURL = null;
    let tinaFileName = fileNameInput || (fileInput.files.length>0 ? fileInput.files[0].name : "TinaéŸ³æª”");
    if(fileInput.files.length>0){
        tinaAudioURL = URL.createObjectURL(fileInput.files[0]);
    }
    
    tongueTwisters[level].push({text:text, tinaAudio:tinaAudioURL, tinaFileName:tinaFileName, studentAudios:[]});
    
    document.getElementById('twisterText').value='';
    fileInput.value='';
    document.getElementById('tinaFileName').value='';
    
    renderTwisters();
}

// å­¸å“¡éŒ„éŸ³ä¸Šå‚³ä¸¦æ¯”å° Tina éŸ³æª”
function uploadStudentAudio(event, level, index){
    const files = event.target.files;
    const container = document.getElementById(`studentAudio-${level}-${index}`);
    const feedback = document.getElementById(`feedback-${level}-${index}`);
    container.innerHTML = '';
    feedback.innerHTML = '';

    Array.from(files).forEach(file=>{
        const url = URL.createObjectURL(file);
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = url;
        container.appendChild(audio);
        tongueTwisters[level][index].studentAudios.push({name:file.name, url:url});

        // ç°¡å–®æ¯”å°ï¼šå¹³å‡éŸ³é‡å·®ç•°
        if(tongueTwisters[level][index].tinaAudio){
            compareAudio(tongueTwisters[level][index].tinaAudio, url, feedback);
        }
    });
}

// ç°¡å–®æ¯”å°ï¼šéŸ³é‡å³°å€¼å·®ç•°
function compareAudio(tinaURL, studentURL, feedbackDiv){
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const context = new AudioContext();

    Promise.all([fetch(tinaURL).then(r=>r.arrayBuffer()), fetch(studentURL).then(r=>r.arrayBuffer())])
    .then(buffers=>Promise.all(buffers.map(b=>context.decodeAudioData(b))))
    .then(decoded=>{
        const [tinaData, studentData] = decoded;
        const tinaVol = getAvgVolume(tinaData.getChannelData(0));
        const studentVol = getAvgVolume(studentData.getChannelData(0));
        const diff = Math.abs(tinaVol - studentVol);
        if(diff < 0.05){
            feedbackDiv.textContent = "ğŸ‰ ç™¼éŸ³æ¥è¿‘ Tinaï¼";
        } else if(diff < 0.15){
            feedbackDiv.textContent = "ğŸ™‚ ç™¼éŸ³ç¨æœ‰å·®ç•°ï¼Œå¯ä»¥å†æ¸…æ™°ä¸€äº›";
        } else {
            feedbackDiv.textContent = "âš ï¸ ç™¼éŸ³å·®ç•°è¼ƒå¤§ï¼Œå»ºè­°å†ç·´ç¿’";
        }
    })
    .catch(err=>{
        console.log("éŸ³è¨Šæ¯”å°éŒ¯èª¤:", err);
        feedbackDiv.textContent = "âš ï¸ ç„¡æ³•æ¯”å°éŸ³è¨Š";
    });
}

function getAvgVolume(data){
    let sum = 0;
    for(let i=0;i<data.length;i++){
        sum += Math.abs(data[i]);
    }
    return sum/data.length;
}

// åˆå§‹åŒ–
renderTwisters();
</script>

</body>
</html>
